<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="../layout/default">
<head></head>
<body>
<div>
    <header></header>
    <aside>/</aside>
    <!-- Content Wrapper. Contains page content -->
    <div layout:fragment="content" class="content-wrapper" >

        <!-- Content Header (Page header) -->
        <section class="content-header">
            <h1>
                서비스 제어
            </h1>
        </section>

        <!-- Main content -->
        <section class="content">
            <div class="row">
                <div class="col-xs-12">
                    <div class="box">
                        <div id="loadingBar" class="overlay"><i class="fa fa-refresh fa-spin"></i></div>
                        <div class="box-body">
                            <table class="table table-striped text-center"> <!-- table-responsive -->
                                <thead>
                                <tr>
                                    <th width="30%">이름</th>
                                    <th width="30%">플랜</th>
                                    <th width="30%">접근</th>
                                    <th width="30%">조직</th>
                                </tr>
                                </thead>
                                <tbody id="servicePlanList" th:remove="body">
                                </tbody>
                            </table>
                        </div>
                        <!-- /.box-body -->
                    </div>
                    <!-- /.box -->
                </div>

            </div>

            <!-- Modal Layer-->
            <div class="modal fade" id="serviceAccessFormModal" data-backdrop="static" data-keyboard="false">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span></button>

                            <h4 class="modal-title">
                                <div id="titleDetail">서비스 제어</div>
                            </h4>
                        </div>
                        <div class="modal-body">

                            <div class="box" style="margin-bottom: 0px; border-top: 0px; box-shadow: 0 0px 0px">
                                <div id="modalLoadingBar" class="overlay hide"><i class="fa fa-refresh fa-spin"></i></div>
                                <form id="serviceAccessForm" class="form-horizontal">
                                    <div class="box-body">

                                        <div class="form-group required">
                                            <label for="servicebrokername" class="col-sm-3 control-label">서비스 브로커 이름</label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control toCheckString" id="servicebrokername" name="servicebrokername"/>
                                                <input type="hidden" id="label"/>
                                            </div>
                                        </div>

                                        <div class="form-group required">
                                            <label for="servicename" class="col-sm-3 control-label">서비스 이름</label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control toCheckString" id="servicename" name="servicename"/>
                                            </div>
                                        </div>

                                        <div class="form-group required" name="serviceAccessListForm">
                                            <label for="serviceAccessList" class="col-sm-3 control-label">서비스 접근</label>
                                            <div class="col-sm-9">
                                                <select class="form-control checkServiceForm" id="serviceAccessList" name="serviceAccessList" style="width:auto;">
                                                    <option value="true">ALL</option>
                                                    <option value="false">NONE</option>
                                                </select>
                                            </div>
                                        </div>

                                        <div class="form-group required">
                                            <label for="serviceOrgList" class="col-sm-3 control-label">서비스 조직</label>
                                            <div class="col-sm-9">
                                                <select class="form-control checkServiceForm" id="serviceOrgList" name="serviceOrgList" style="width:auto;">
                                                    <option value="true">ALL</option>
                                                    <option value="false">NONE</option>
                                                </select>
                                            </div>
                                        </div>

                                    </div>
                                </form>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="button" id="disableBtn" class="btn btn-sm btn-danger pull-left" onClick="disableServiceAccess();">접근해제</button>
                            <button type="button" id="closeBtn" class="btn btn-sm btn-default pull-left" data-dismiss="modal">취소</button>
                            <button type="button" id="enableBtn" class="btn btn-sm btn-primary pull-right" onClick="enableServiceAccess();">접근허용</button>
                        </div>
                    </div>
                    <!-- /.modal-content -->
                </div>
                <!-- /.modal-dialog -->
            </div>

            <div class="modal fade" tabindex="-1" role="dialog" id="serviceBrokerConfirmModal">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true"> &times; </span></button>
                            <h1 id="popupTitle" class="modal-title" style="font-size:25px"> TITLE </h1>
                        </div>
                        <div class="modal-body">
                            <p id="popupMessage"> MESSAGE </p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-sm btn-danger" data-dismiss="modal" id="popupButtonText"> SAVE CHANGES </button>
                            <button type="button" class="btn btn-sm btn-default" data-dismiss="modal" id="popupCancelButtonText"
                                    onclick="procClosePopup('serviceBrokerConfirmModal');"> 취소
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Modal Layer-->
        </section>
        <!-- /.Content -->
    </div>
    <!-- /.content-wrapper -->

    <footer></footer>

</div>
<!-- ./wrapper -->

<script th:inline="javascript" type="text/javascript" layout:fragment="custom-script">
    /*<![CDATA[*/

    var orgObj = new Object();

    var SELECT_SERVICE_PACK_NAME;

    var SERVICE_LIST;                         //서비스팩 전체 리스트
    var SERVICE_ACCESS_LIST;                 //서비스 제어 전체 리스트


    var init = function(){
        getServicePlanList();
        $('#serviceAccessFormModal').modal('hide');
    }

    $(document).ready(function () {

        init();

        $('#register').click(function(){

            $('#titleDetail').hide();
            $('#disableBtn').hide();
            $('#enableBtn').hide();

            $('#regBtn').show();
            $('#closeBtn').show();

            $("#servicebrokername").val("");
            $("#servicename").val("");
            $("#label").val("");
        });

        $('#serviceBrokerList').click(function(){

            $('#titleDetail').show();
            $('#deleteBtn').show();
            $('#saveBtn').show();

            $('#regBtn').hide();
            //$('#closeBtn').hide();
        });
    });

    // 조직 전체 목록 리스트
    function getOrgs() {
        procCallAjaxAsyncFalse("/v2/orgs", "GET", null, procCallbackGetOrgs, null);
    };

    var procCallbackGetOrgs = function(data) {
        console.log("data Org   "+data);

        $.each(data.resources, function (index, data) {
            orgObj[data.metadata.guid] = data.entity.name;
        });
        console.log(orgObj);
    }


    // [서비스제어] 전체 목록 리스트 [동기화]
    function getServicePlanList(){
        procCallAjaxAsyncFalse("/v2/servicepacks", "GET", null, procCallbackGetServiceList, $('#loadingBar') );
    };


    var procCallbackGetServiceList = function(data){
        getOrgs();

        SERVICE_LIST= data;
        printData(SERVICE_LIST);
    }

    //[서비스제어] 리스트 출력 [동기화]
    function printData(dataList) {

        console.log(":::SERVICE_LIST DATA:::");
        console.log(dataList);

        var entity = dataList.list;
        console.log(entity);

        $.each(entity, function (id, data) {
            if(data.servicePackName != "NONE") {
                console.log(data.servicePackName);
                SELECT_SERVICE_PACK_NAME = data.servicePackName;
                procCallAjaxAsyncFalse("/v2/catalogs/serviceplan/"+data.servicePackName, "GET", null, procCallbackGetServicePlan, $('#modalLoadingBar'));
            }
        });

    };

    var procCallbackGetServicePlan = function(data){
        SERVICE_ACCESS_LIST = "";

        $.each(data.resources, function (id, data2) {
            var accessText = "None";
            if(data2.entity.public) {
                accessText= "All";
            }

            SERVICE_ACCESS_LIST += "<tr>";
//            SERVICE_ACCESS_LIST += "<td onclick='javascript:getServicePlanDetail(\""+data.servicePackName+"\")'>"+SELECT_SERVICE_PACK_NAME+"</td> ";
            SERVICE_ACCESS_LIST += "<td>"+SELECT_SERVICE_PACK_NAME+"</td> ";
            SERVICE_ACCESS_LIST += "<td>"+data2.entity.name+"</td> ";
            SERVICE_ACCESS_LIST += "<td id='service_access_"+data2.metadata.guid+"'>"+accessText+"</td> ";
            SERVICE_ACCESS_LIST += "<td id='service_plan_"+data2.metadata.guid+"'></td>";
            SERVICE_ACCESS_LIST += "</tr> ";
        });

        $("#servicePlanList").append(SERVICE_ACCESS_LIST);

        $.each(data.resources, function (id, data0rg) {
            procCallAjaxAsyncFalse("/v2/serviceplans/"+data0rg.metadata.guid+"/visibilites", "GET", null, procCallbackGetServicePlanVisibilites, $('#modalLoadingBar'));
        });
    };


    var procCallbackGetServicePlanVisibilites = function(data){
        if(data.resources.length > 0) {
            $.each(data.resources, function (id, data3) {
                $("#service_plan_"+data3.entity.service_plan_guid).append(orgObj[data3.entity.organization_guid]+" ");

                //접근 리스트
                $("#service_access_"+data3.entity.service_plan_guid).text('limited');
            });
        }
    };


    /*
    // 서비스 상세
    function getServicePlanDetail(label) {
        $('#serviceAccessForm')[0].reset();
        $('#serviceAccessFormModal').modal('toggle');
        procCallAjax("/v2/catalogs/serviceplan/"+label, "GET", null, procCallbackGetPlandDtailList, $('#modalLoadingBar'));
    }

    var procCallbackGetPlanDetailList = function(data){
        SERVICE_ACCESS_DETAIL_LIST= data.resources;
        printAccessData(SERVICE_ACCESS_DETAIL_LIST);
    }

    function printAccessData(dataList) {
        console.debug(":::SERVICE_ACCESS_DETAIL_LIST DATA:::");
        console.debug(dataList[0]);
        console.debug(":::SERVICE_LIST DATA:::");
        console.debug(SERVICE_LIST[0]);

        var entity = dataList[0].entity;
        var service = SERVICE_LIST[0].entity;


        //서비스 브로커 이름
        $("#servicebrokername").val(service.label);

        //서비스 플랜 이름
        $("#servicename").val(entity.name);

        //서비스 접근
        $("#serviceAccessList").val(entity.public);
//        $(document).on("change keyup"," select[id=serviceAccessList]",function(e){
//            var value = $('#serviceAccessList').val(entity.public);
//        })
    }

*/

    // 서비스 제어 접근허용[update]
    function enableServiceAccess() {

        var guid = $('#guid').val();

        if (!procCheckValidStringSpace()){
            return false;
        };

        var param = {
            guid: guid,
            name: $("#name").val()
        }
        procCallAjax("/v2/serviceplans/"+guid, "PUT", JSON.stringify(param), init, $('#modalLoadingBar'));
    }

    /*]]>*/
</script>
</body>
</html>
