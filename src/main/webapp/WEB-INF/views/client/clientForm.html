<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorator="../layout/default">
<head></head>
<body>
<div>
  <header></header>
  <aside>/</aside>

  <!-- Content Wrapper. Contains page content -->
    <div layout:fragment="content" class="content-wrapper" th:with="UPDATE_CD = ${T(org.openpaas.paasta.portal.web.admin.common.Constants).CUD_U}, INSERT_CD = ${T(org.openpaas.paasta.portal.web.admin.common.Constants).CUD_C} ">

      <!-- Content Header (Page header) -->
      <section class="content-header">
        <h1>
          <div th:if=" ${INSERT_FLAG} == ${UPDATE_CD} ">
            클라이언트 상세
          </div>
          <div th:if=" ${INSERT_FLAG} == ${INSERT_CD} ">
            클라이언트 등록
          </div>
        </h1>
      </section>

      <!-- Main content -->
      <section class="content">
        <div class="row">
          <div class="col-xs-12">
            <div class="box"> <!--box-info -->
              <div class="box-header"> <!--  with-border -->

              </div>
              <!-- /.box-header -->

              <form class="form-horizontal">
                <div class="box-body">
                  <div class="form-group">
                    <label for="uaacClientId" class="col-sm-2 control-label">아이디</label>
                    <div class="col-sm-10">
                      <input type="email" class="form-control" id="uaacClientId" placeholder="ID"
                      th:style="${INSERT_FLAG} == ${UPDATE_CD} ? 'background:white;cursor:default;' : ''"
                      th:disabled="${INSERT_FLAG} == ${UPDATE_CD}"/>

                    </div>
                  </div>

                  <div class="form-group" th:if="${INSERT_FLAG} == ${INSERT_CD}">
                    <label for="uaacClientPw" class="col-sm-2 control-label">패스워드</label>
                    <div class="col-sm-10">
                      <input type="password" class="form-control" id="uaacClientPw" placeholder="Password" />
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="clientOption" class="col-sm-2 control-label">옵션</label>
                    <div class="col-sm-10">
                      <textarea class="form-control" rows="5" id="clientOption"></textarea>
                    </div>
                  </div>

                  <div class="form-group">
                    <label for="clientGuide" class="col-sm-2 control-label">옵션 가이드</label>
                    <div class="col-sm-10">
                    <textarea class="form-control" rows="13" id="clientGuide" style="background: white; cursor: text" readonly="true">
새 클라이언트 등록시 옵션 설정 예제)
    --authorized_grant_types client_credentials

---------------------------------------------------------------------------------------------------------------------------
클라이언트 주요 옵션 설명

  --authorities
                :       클라이언트에 대한 접근 권한 설정
                        (참고 : https://github.com/cloudfoundry/uaa/blob/master/docs/UAA-Security.md#security-metadata)
  --scope
                :       유저의 역할에 대한 설정
                        (참고 : https://github.com/cloudfoundry/uaa/blob/master/docs/UAA-Security.md#token-scope-rules)
  --authorized_grant_types
                :       OAuth2 grant type들의 목록. 클라이언트 등록시 필수 옵션
                        client_credentials, password, implicit, refresh_token, authorization_code


클라이언트 등록시 사용 가능한 옵션 목록

   --name &lt;string&gt;
   --scope &lt;list&gt;
   --authorized_grant_types &lt;list&gt;
   --authorities &lt;list&gt;
   --access_token_validity &lt;seconds&gt;
   --refresh_token_validity &lt;&lt;seconds&gt;
   --redirect_uri &lt;list&gt;
   --autoapprove &lt;&lt;list&gt;
   --signup_redirect_url &lt;url&gt;
   --clone &lt;other&gt;, get default settings from other
   -s | --secret &lt;secret&gt;, client secret
   -i | --[no-]interactive, interactively verify all values

---------------------------------------------------------------------------------------------------------------------------

More Information : # https://sks.gitbooks.io/my-road-2-industrial-applications/content/en/Security/registering_client_in_uaa.html
                   # https://github.com/cloudfoundry/uaa/blob/master/docs/UAA-APIs.rst#id85
                    </textarea> <!-- disabled="" -->
                    </div>
                  </div>

                  <div class="form-group">
                    <div class="col-sm-2">
                    </div>
                    <div class="col-sm-10">
                      <button type="button" class="btn btn-default btn-sm pull-right" id="btnCancel">취소</button>
                      <button type="button" class="btn btn-primary btn-sm pull-right" id="btnRegist" style="margin-right: 5px;" >등록</button>
                      <button type="button" class="btn btn-default btn-sm pull-left" id="btnDelete">삭제</button>
                    </div>
                  </div>

                </div>
                <!-- /.box-body -->

                <!--box-footer-->

                <!-- /.box-footer -->
              </form>

            </div>
            <!-- /.box -->
          </div>
        </div>

        <!-- Modal Layer-->
        <div class="modal fade" id="modal-default" style="display: none;">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                  <span aria-hidden="true">×</span></button>
                <h4 class="modal-title">Default Modal</h4>
              </div>
              <div class="modal-body">
                <p>One fine body…</p>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default pull-left" data-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary">Save changes</button>
              </div>
            </div>
            <!-- /.modal-content -->
          </div>
          <!-- /.modal-dialog -->
        </div>
        <!-- Modal Layer-->

      </section>
      <!-- /.content -->
    </div>
  <!-- /.content-wrapper -->

  <footer></footer>

</div>
<!-- ./wrapper -->

<script th:inline="javascript" type="text/javascript" layout:fragment="custom-script">
  /*<![CDATA[*/
  var INSERT_FLAG = /*[[${INSERT_FLAG}]]*/ "";

  if(INSERT_FLAG == null){
    INSERT_FLAG = "";
  }

  var TO_LIST = "/client/clientMain";

  var GET_PROC_URL = "/client/getClient";
  var REGISTER_PROC_URL = "/client/registerClient";
  var UPDATE_PROC_URL = "/client/updateClient";
  var DELETE_PROC_URL = "/client/deleteClient";

  $(document).ready(function(){
    if (INSERT_FLAG != "" && INSERT_FLAG == CUD_U) { // get
      procGetClient();
    } else {
      $("#clientOption").val("--authorized_grant_types AUTHORIZED_GRANT_TYPES");
    }
  });

  function procGetClient() {
    var client_id = /*[[${CLIENT_ID}]]*/ "";
    var param = {
      client_id : client_id
    }
    procCallAjax(GET_PROC_URL, param, procCallbackGetClient);
  }

  var procCallbackGetClient = function (data) {

    var options = "";

    var name = data.info.name;
    if (name != undefined && name != "") if (name != "") options += "--name " + name + " ";

    var scope = data.info.scope;
    if (scope != undefined) if (scope != "") options += "--scope " + scope + " ";

    var authorized_grant_types = data.info.authorized_grant_types;
    if (authorized_grant_types != undefined) if (authorized_grant_types != "") options += "--authorized_grant_types " + authorized_grant_types + " ";

    var authorities = data.info.authorities;
    if (authorities != undefined) if (authorities != "") options += "--authorities " + authorities + " ";

    var access_token_validity = data.info.access_token_validity;
    if (access_token_validity != undefined) if (access_token_validity != "") options += "--access_token_validity " + access_token_validity + " ";

    var refresh_token_validity = data.info.refresh_token_validity;
    if (refresh_token_validity != undefined) if (refresh_token_validity != "") options += "--refresh_token_validity " + refresh_token_validity + " ";

    var redirect_uri = data.info.redirect_uri;
    if (redirect_uri != undefined) if (redirect_uri != "") options += "--redirect_uri " + redirect_uri + " ";

    var autoapprove = data.info.autoapprove;
    if (autoapprove != undefined) if (autoapprove != "") options += "--autoapprove " + autoapprove + " ";

    var signup_redirect_url = data.info.signup_redirect_url;
    if (signup_redirect_url != undefined) if (signup_redirect_url != "") options += "--signup_redirect_url " + signup_redirect_url + " ";

    var clone = data.info.clone;
    if (clone != undefined) if (clone != "") options += "--clone " + clone + " ";


    $("#uaacClientId").val(data.info.client_id);
    $("#clientOption").val(options);

  }

  function parsingClientOptions () {
    var client_id  = $("#uaacClientId").val();
    var clientOption = $("#clientOption");
    var checkString = '-';
    var checkEmptyString = ' ';

    var param = {
      client_id : client_id
    };

    if (!procCheckValidation(param)) return false;

    if (clientOption.val().indexOf(checkString) == -1) {
      procAlert("warning", '<spring:message code="common.client.option.validation.error.message" />');
      clientOption.focus();
      return false;
    }

    var clientOptions = clientOption.val().trim();

    // parsing client options
    var optionLine =  clientOptions.split(checkString);
    var tempOptionLine = '';

    for (var i = 0; i < optionLine.length; i++) {
      if (optionLine[i] != "") {

        tempOptionLine = optionLine[i].trim();

        if (tempOptionLine.indexOf(checkEmptyString) == -1) {
          procAlert("warning", /*[[#{common.client.option.validation.error.message}]]*/ "");
          clientOption.focus();
          return false;
        }

        var option = tempOptionLine.split(checkEmptyString);
        var optionLength = option.length;
        var optionName = option[0];
        var optionContent;

        if (optionLength > 2) { // name, String
          optionContent = "";
          for (var j = 1; j < option.length; j++) {
            optionContent =  optionContent + option[j].toString() + checkEmptyString;
          }

        } else {
          var contents = option[1].split(',');
          optionContent = [];
          for (var k = 0; k < contents.length; k++) {
            optionContent[k] = contents[k];
          }
        }

        var renew = paramSetting(param, optionName, optionContent);
        $.extend(param, renew);

      }
    }

    // call ajax
    if (INSERT_FLAG != "" && INSERT_FLAG == CUD_U) { // update
      procCallAjax(UPDATE_PROC_URL, param, procCallbackRegisterUpdateClient);
    } else { // register
      $.extend(param, {client_secret : $("#uaacClientPw").val()});
      procCallAjax(REGISTER_PROC_URL, param, procCallbackRegisterUpdateClient);
    }
  }

  function procCheckValidation(param) {

    if (param.client_id == '') {
      procAlert("warning", /*[[#{common.info.empty.req.data}]]*/ "");
      $("#uaacClientId").focus();
      return false;
    }

    if ($("#uaacClientPw").val()  == '' || $("#uaacClientPw").val() == "") {
      procAlert("warning", /*[[#{common.info.empty.req.data}]]*/ "");
      $("#uaacClientPw").focus();
      return false;
    }

    if (param.authorized_grant_types  == '') {
      procAlert("warning", '--authorized_grant_types 옵션은 필수 입니다.');
      $("#clientOption").focus();
      return false;
    }

    return true;
  }

  // Register, Update CALLBACK
  var procCallbackRegisterUpdateClient = function(data) {

    if (RESULT_STATUS_SUCCESS == data.RESULT) {
      procAlert("success", /*[[#{common.info.result.success}]]*/ "" );
      procMovePage(TO_LIST);

    } else {
      procAlert("danger", data.RESULT_MESSAGE);
    }
  };

  function paramSetting(param, optionName, optionContent) {

    if (optionName == "name") {
      return newParam = {name : optionContent};

    } else if (optionName == "scope" ) {
      return newParam = {scope : optionContent};

    } else if (optionName == "authorized_grant_types") {
      return newParam = {authorized_grant_types : optionContent};

    } else if (optionName == "authorities") {
      return newParam = {authorities : optionContent};

    } else if (optionName == "access_token_validity") {
      return newParam = {access_token_validity : optionContent};

    } else if (optionName == "refresh_token_validity") {
      return newParam = {refresh_token_validity : optionContent};

    } else if (optionName == "redirect_uri") {
      return newParam = {redirect_uri : optionContent};

    } else if (optionName == "autoapprove") {
      return newParam = {autoapprove : optionContent};

    } else if (optionName == "signup_redirect_url" ) {
      return newParam = {signup_redirect_url : optionContent};

    } else if (optionName == "clone") {
      return newParam = {clone : optionContent};

    } else if (optionName == "s") {
      return newParam = {client_secret : optionContent.toString()};
    } else if (optionName == "i") {
      return newParam = {client_secret : optionContent.toString()};
    }
  }

  // DELETE CLIENT
  var procCallbackDeleteClient = function(data) {

    if (RESULT_STATUS_SUCCESS == data.RESULT) {
      procAlert("success", /*[[#{common.info.result.success}]]*/ "" );
      procMovePage(TO_LIST);
    } else {
      procAlert("danger", data.RESULT_MESSAGE);
    }
  };

  function procDeleteClient() {

    var client_id = "${CLIENT_ID}";

    var param = {
      client_id : client_id
    }
    procCallAjax(DELETE_PROC_URL, param, procCallbackDeleteClient);

  }

  // BIND :: BUTTON EVENT
  $("#btnRegist").on("click", function() {
    alert("ASDHKAJHSKDH");
    parsingClientOptions();
  });

  // BIND :: BUTTON EVENT
  $("#btnCancel").on("click", function() {
    procMovePage(TO_LIST);
  });

  // BIND :: BUTTON EVENT
  $("#btnDelete").on("click", function() {

    procPopup('클라이언트', '\"' + $("#uaacClientId").val() + '\" ' + DELETE_MESSAGE, 'procDeleteClient();');
    $('#popupButtonText').html("삭제");
  });

  /*]]>*/
</script>


</body>
</html>
